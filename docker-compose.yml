# ============================================================================
# Tachyon - Docker Compose
# Quick start for development and testing
# ============================================================================

version: '3.8'

services:
  # -------------------------------------------------------------------------
  # Tachyon Relay Server (Self-hosted)
  # -------------------------------------------------------------------------
  tachyon-server:
    build:
      context: .
      dockerfile: Dockerfile.server
    container_name: tachyon-server
    ports:
      - "443:443"      # HTTPS (public traffic)
      - "8443:8443"    # Control plane (tunnel clients)
      - "9090:9090"    # Metrics (Prometheus)
    environment:
      - TACHYON_DOMAIN=${TACHYON_DOMAIN:-localhost}
      - TACHYON_LOG_LEVEL=${TACHYON_LOG_LEVEL:-info}
    volumes:
      - ./certs:/certs:ro
      - tachyon-data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8443/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    networks:
      - tachyon-network

  # -------------------------------------------------------------------------
  # Tachyon Client (Example - connects to server)
  # -------------------------------------------------------------------------
  tachyon-client:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: tachyon-client
    command: ["--port", "8000", "--server", "tachyon-server:8443"]
    environment:
      - TACHYON_SERVER=tachyon-server:8443
      - TACHYON_AUTH_TOKEN=${TACHYON_AUTH_TOKEN:-}
    depends_on:
      tachyon-server:
        condition: service_healthy
    network_mode: host  # Access host's localhost services
    restart: unless-stopped
    profiles:
      - client  # Only start with: docker-compose --profile client up

  # -------------------------------------------------------------------------
  # Example: Your application that Tachyon tunnels
  # -------------------------------------------------------------------------
  example-app:
    image: nginx:alpine
    container_name: example-app
    ports:
      - "8000:80"
    volumes:
      - ./example:/usr/share/nginx/html:ro
    restart: unless-stopped
    networks:
      - tachyon-network
    profiles:
      - example  # Only start with: docker-compose --profile example up

  # -------------------------------------------------------------------------
  # Prometheus (Optional - for metrics)
  # -------------------------------------------------------------------------
  prometheus:
    image: prom/prometheus:latest
    container_name: tachyon-prometheus
    ports:
      - "9091:9090"
    volumes:
      - ./deploy/docker/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
    restart: unless-stopped
    networks:
      - tachyon-network
    profiles:
      - monitoring

  # -------------------------------------------------------------------------
  # Grafana (Optional - for dashboards)
  # -------------------------------------------------------------------------
  grafana:
    image: grafana/grafana:latest
    container_name: tachyon-grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin}
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - grafana-data:/var/lib/grafana
    depends_on:
      - prometheus
    restart: unless-stopped
    networks:
      - tachyon-network
    profiles:
      - monitoring

# Networks
networks:
  tachyon-network:
    driver: bridge

# Volumes
volumes:
  tachyon-data:
    driver: local
  prometheus-data:
    driver: local
  grafana-data:
    driver: local
